<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Primary Meta Tags -->
    <title>K-12 School Solutions | Greenheck</title>
    <meta name="title" content="K-12 School Solutions | Greenheck" />
    <meta name="description" content="Comprehensive HVAC solutions for K-12 schools including ventilation, energy recovery, and air quality systems designed for educational facilities." />
    <meta name="keywords" content="K-12 school HVAC, school ventilation, educational facility HVAC, school air quality, energy efficient schools" />
    <meta name="author" content="Greenheck Fan Corporation" />
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
    <meta name="googlebot" content="index, follow" />
    <meta name="bingbot" content="index, follow" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.greenheck.com/k-12-school.html" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.greenheck.com/k-12-school.html" />
    <meta property="og:title" content="K-12 School Solutions | Greenheck" />
    <meta property="og:description" content="Comprehensive HVAC solutions for K-12 schools including ventilation, energy recovery, and air quality systems designed for educational facilities." />
    <meta property="og:image" content="https://www.greenheck.com/Content/imgs/school/k-12-hero-bg.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="K-12 school HVAC solutions" />
    <meta property="og:site_name" content="Greenheck" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://www.greenheck.com/k-12-school.html" />
    <meta name="twitter:title" content="K-12 School Solutions | Greenheck" />
    <meta name="twitter:description" content="Comprehensive HVAC solutions for K-12 schools including ventilation, energy recovery, and air quality systems designed for educational facilities." />
    <meta name="twitter:image" content="https://www.greenheck.com/Content/imgs/school/k-12-hero-bg.png" />
    <meta name="twitter:image:alt" content="K-12 school HVAC solutions" />

    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#075697" />
    <meta name="msapplication-TileColor" content="#075697" />
    <meta name="application-name" content="Greenheck" />
    <meta name="apple-mobile-web-app-title" content="Greenheck" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.google-analytics.com" />

    <!-- DNS Prefetch -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./Content/imgs/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="./Content/imgs/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./Content/imgs/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./Content/imgs/favicon-180.png" />
    <link rel="manifest" href="./site.webmanifest" />

    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&URL_ADDRESS" />

    <!-- External CSS -->
    <link rel="stylesheet" href="./Content/css/common.css" />
    <link rel="stylesheet" href="./Content/css/header.css" />
    <link rel="stylesheet" href="./Content/css/product.css" />
    <link rel="stylesheet" href="./Content/css/footer.css" />
    <link rel="stylesheet" href="./Content/css/k-12-school.css" />

    <!-- Schema.org JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Organization",
            "@id": "https://www.greenheck.com/#organization",
            "name": "Greenheck Fan Corporation",
            "url": "https://www.greenheck.com",
            "logo": {
              "@type": "ImageObject",
              "url": "https://www.greenheck.com/Content/imgs/Greenheck_Logo_Horizontal_Blue.png",
              "width": 200,
              "height": 60
            },
            "sameAs": [
              "https://www.linkedin.com/company/greenheck",
              "https://www.facebook.com/GreenheckFan",
              "https://www.youtube.com/user/GreenheckFan"
            ],
            "contactPoint": {
              "@type": "ContactPoint",
              "telephone": "+1-715-359-6171",
              "contactType": "customer service",
              "availableLanguage": "English"
            },
            "address": {
              "@type": "PostalAddress",
              "addressCountry": "US",
              "addressLocality": "Schofield",
              "addressRegion": "WI",
              "postalCode": "54476",
              "streetAddress": "P.O. Box 410"
            }
          },
          {
            "@type": "WebSite",
            "@id": "https://www.greenheck.com/#website",
            "url": "https://www.greenheck.com",
            "name": "Greenheck - Building Value in Air",
            "description": "Greenheck Fan Corporation provides comprehensive HVAC solutions including fans, dampers, louvers, energy recovery systems, and air terminal units for commercial and industrial applications.",
            "publisher": {
              "@id": "https://www.greenheck.com/#organization"
            },
            "potentialAction": {
              "@type": "SearchAction",
              "target": "https://www.greenheck.com/search?q={search_term_string}",
              "query-input": "required name=search_term_string"
            }
          },
          {
            "@type": "BreadcrumbList",
            "@id": "https://www.greenheck.com/#breadcrumb",
            "itemListElement": [
              {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://www.greenheck.com"
              },
              {
                "@type": "ListItem",
                "position": 2,
                "name": "Building Type",
                "item": "https://www.greenheck.com/building-type"
              },
              {
                "@type": "ListItem",
                "position": 3,
                "name": "K-12 School",
                "item": "https://www.greenheck.com/k-12-school.html"
              }
            ]
          },
          {
            "@type": "Service",
            "@id": "https://www.greenheck.com/#k12-school-solutions",
            "name": "K-12 School HVAC Solutions",
            "description": "Comprehensive HVAC solutions for K-12 schools including ventilation, energy recovery, and air quality systems designed for educational facilities.",
            "provider": {
              "@id": "https://www.greenheck.com/#organization"
            },
            "areaServed": {
              "@type": "Country",
              "name": "United States"
            },
            "serviceType": "HVAC Systems for Educational Facilities"
          }
        ]
      }
    </script>
</head>

<body>
    <!-- Header include -->
    <div data-include="./Content/includes/header.html"></div>
    <!-- Anchor for scroll to top -->
    <div id="top"></div>

    <!-- Main Content -->
    <main id="main-content" role="main">
        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb" aria-label="Breadcrumb navigation">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/" class="breadcrumb-link">Home</a>
                </li>
                <li class="breadcrumb-item">
                    <span class="material-symbols-outlined breadcrumb-arrow">chevron_right</span>
                </li>
                <li class="breadcrumb-item">
                    <span class="breadcrumb-current" aria-current="page">K-12 School</span>
                </li>
            </ol>
        </nav>

        <h1 class="page-title">K-12 School</h1>
        <section class="hero-section">
            <img src="./Content/imgs/k-12-hero-bg.png" alt="Building exterior view of Greenheck High School" class="hero-background" />
            <div class="hero-overlay">
                <div class="hero-content">
                    <h2 class="hero-title">SHARE</h2>
                    <p class="hero-description">
                        THIS INFORMATIVE, USEFUL<br>
                        & ENGAGING EXPERIENCE
                    </p>
                    <div class="hero-buttons">
                        <button class="hero-btn hero-btn-primary" id="select-space-btn">
                            <img src="./Content/imgs/icons/select-a-space.svg" alt="Select a Space" />
                            Select a Space
                        </button>
                        <button class="hero-btn">
                            <img src="./Content/imgs/icons/share.svg" alt="Share" />
                            Share
                        </button>
                    </div>
                </div>
            </div>
        </section>
        <h2 class="section-title">Healthier Indoor Air is the Answer</h2>
        <p class="section-description">
            Greenheck offers a complete line of ventilation products for educational facilities that create a safe, comfortable, and productive environment for students and staff while keeping operating and installation
            costs low.
        </p>
        <p class="section-description">
            Our products are designed to work together as complete, integrated systems that incorporate ventilation, filtration, humidification, and air circulation for healthier indoor spaces and improved learning.
        </p>
        <!-- Space Selection Modal -->
        <div id="space-selection-modal" class="space-selection-modal-overlay w-full p-0 m-0" style="display: none;">
            <div class="space-selection-modal-container">
                <!-- Modal Header -->
                <div class="space-selection-modal-header">
                    <div class="space-selection-modal-header-left">
                        <button class="space-selection-modal-back-btn" id="modal-back-btn" style="display: none;">
                            <span class="material-symbols-outlined">keyboard_arrow_down</span>
                        </button>
                        <div class="space-selection-modal-title" id="modal-title">
                            <div class="space-selection-modal-space-name"></div>
                            <div class="space-selection-modal-system-name" id="modal-system-name" style="display: none;">Dedicated Outdoor Air System (DOAS)</div>
                        </div>
                    </div>
                    <div class="space-selection-modal-tabs" id="modal-tabs">
                        <button class="space-selection-modal-tab" data-tab="overview">Overview</button>
                        <button class="space-selection-modal-tab" data-tab="system-equipment">System Equipment</button>
                        <button class="space-selection-modal-tab" data-tab="design-narrative">Design Narrative</button>
                        <button class="space-selection-modal-share-btn">
                            <img src="./Content/imgs/icons/share-modal.svg" alt="Share" />
                            Share
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="space-selection-modal-content">
                    <button class="space-selection-modal-close-btn" id="modal-close-btn">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                    <!-- Building Overview Scene -->
                    <div id="building-overview-scene" class="scene active">
                        <div class="school-building-container">
                            <div class="school-building">
                                <object id="building-svg-object" data="./Content/imgs/K-12Map-with-Pins.svg" type="image/svg+xml" class="school-building-image"></object>
                                <!-- Marker Overlay Container -->
                                <div id="marker-overlay-container" class="marker-overlay-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Popover -->
                    <div id="space-popover" class="space-popover" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-header">

                                <button class="popover-close-btn" id="popover-close-btn">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <div class="popover-body">
                                <h3 id="popover-space-name">Classroom</h3>
                                <p id="popover-system-name">Dedicated Outdoor Air System (DOAS)</p>
                                <button class="popover-view-btn" id="popover-view-btn">View</button>
                            </div>
                        </div>
                    </div>

                    <!-- Detail Scene -->
                    <div id="detail-scene" class="scene">
                        <div class="detail-content">
                            <!-- Left Panel - Text Content -->
                            <div class="detail-left-panel">
                                <div class="detail-text-content">
                                    <!-- Overview Tab Content -->
                                    <div id="overview-content" class="tab-content active">
                                        <h3 id="detail-title">Classroom Overview</h3>
                                        <p id="detail-description">
                                            The flexible design decouples ventilation air and loads, allowing the DOAS units to handle latent loads and condition air while secondary HVAC systems handle sensible loads.
                                            This
                                            approach provides better control, energy efficiency, and comfort. Proper control is essential for maintaining comfort and extending equipment lifespan.
                                        </p>
                                        <h4>Featured Equipment</h4>
                                        <ul>
                                            <li>Dedicated Outdoor Air System (DOAS) with energy recovery</li>
                                            <li>Secondary HVAC system (not provided by Greenheck)</li>
                                        </ul>
                                    </div>

                                    <!-- System Equipment Tab Content -->
                                    <div id="system-equipment-content" class="tab-content">
                                        <div class="product-carousel">
                                            <div class="product-card active" data-product="rve-85">
                                                <h3>RVE-85</h3>
                                                <div class="product-image-container">
                                                    <button class="carousel-prev">‹</button>
                                                    <div class="product-image">
                                                        <div class="hvac-unit-3d">HVAC Unit 3D</div>
                                                    </div>
                                                    <button class="carousel-next">›</button>
                                                </div>
                                                <div class="carousel-dots">
                                                    <span class="dot active"></span>
                                                    <span class="dot"></span>
                                                    <span class="dot"></span>
                                                    <span class="dot"></span>
                                                </div>
                                                <ul class="product-features">
                                                    <li>Direct drive plenum supply and optional exhaust fans with neoprene isolation and factory-provided variable frequency drive.</li>
                                                    <li>2-inch double-wall cabinet with R13 injected foam insulation. R13 foam insulation thermally broken. Exterior Finish Permatector™ (2,500 hr salt spray rating under
                                                        ASTM
                                                        B117 testing conditions)</li>
                                                </ul>
                                                <button class="view-product-details-btn">View Product Details</button>
                                            </div>

                                            <div class="product-card" data-product="atu-xg-th-500">
                                                <h3>ATU - XG-TH-500</h3>
                                                <div class="product-image-container">
                                                    <button class="carousel-prev">‹</button>
                                                    <div class="product-image">
                                                        <div class="hvac-unit-3d">VAV Box 3D</div>
                                                    </div>
                                                    <button class="carousel-next">›</button>
                                                </div>
                                                <div class="carousel-dots">
                                                    <span class="dot active"></span>
                                                    <span class="dot"></span>
                                                    <span class="dot"></span>
                                                </div>
                                                <ul class="product-features">
                                                    <li>Damper rotates in a self-lubricating, long-life, low-friction thermoplastic bearing</li>
                                                    <li>Industry leading continuous welded primary inlet duct to minimize leakage with three stiffening beads for added rigidity</li>
                                                    <li>Mechanically fastened damper assembly shall be double layer, 18-gauge equivalent, galvanized</li>
                                                </ul>
                                                <button class="view-product-details-btn">View Product Details</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Design Narrative Tab Content -->
                                    <div id="design-narrative-content" class="tab-content">
                                        <h3>Classroom Design Narrative</h3>
                                        <p>
                                            The <strong>Dedicated Outdoor Air System (DOAS)</strong> model handles latent loads and conditions air while secondary HVAC systems handle sensible loads. The design centers on
                                            a
                                            <strong>Greenheck model RVE-85, rooftop ventilator</strong> equipped with a <strong>polymer total energy recovery wheel</strong> and a <strong>packaged Air Source Heat Pump
                                                (ASHP)</strong> with electric secondary heating.
                                        </p>
                                        <p>
                                            The unit includes <strong>modulating, inverter scroll compressors</strong>, <strong>electronically commutated (EC) on all condenser fan motors</strong>, and <strong>modulating
                                                hot
                                                gas reheat</strong>. Supply and exhaust fans are controlled by <strong>factory provided, field mounted duct static pressure sensors</strong>.
                                        </p>
                                        <p>
                                            Each room features <strong>motorized, single duct VAV boxes, Greenheck model XG-TH-500</strong>, which open/close based on occupancy to maintain ventilation. Air terminal units
                                            have <strong>1" fiberglass insulation with 1 1/2 lb weight</strong> and connect to a <strong>Greenheck XG-5750 air diffuser</strong>.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Panel - Space SVG View -->
                            <div class="detail-right-panel">
                                <div class="space-svg-container">
                                    <object id="space-svg-object" data="" type="image/svg+xml" class="space-svg-image"></object>
                                    <!-- Marker and Title Overlay Container -->
                                    <div id="space-marker-overlay-container" class="space-marker-overlay-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scroll to Top Button -->
    <a href="#top" class="scroll-to-top" aria-label="Scroll to top">
        <span class="material-symbols-outlined scroll-to-top">arrow_circle_up</span>
    </a>

    <!-- Footer include -->
    <div data-include="./Content/includes/footer.html"></div>

    <!-- Performance and Analytics Scripts -->
    <script>
        // Performance optimization: Lazy load images
        document.addEventListener("DOMContentLoaded", function () {
            // Add loading="lazy" to images when they're added
            const images = document.querySelectorAll("img");
            images.forEach((img) => {
                img.setAttribute("loading", "lazy");
            });

            // Smooth scrolling for anchor links
            const anchorLinks = document.querySelectorAll('a[href^="#"]');
            anchorLinks.forEach((link) => {
                link.addEventListener("click", function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute("href"));
                    if (target) {
                        target.scrollIntoView({
                            behavior: "smooth",
                            block: "start",
                        });
                    }
                });
            });
        });

        // Service Worker registration for PWA capabilities
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", function () {
                navigator.serviceWorker
                    .register("/sw.js")
                    .then(function (registration) {
                        console.log("ServiceWorker registration successful");
                    })
                    .catch(function (err) {
                        console.log("ServiceWorker registration failed");
                    });
            });
        }
    </script>
    <!-- Include utility must load before header.js to ensure includes are loaded first -->
    <script src="./Content/js/includes.js"></script>
    <script src="./Content/js/header.js"></script>
    <script>
        // Accordion functionality for mobile/tablet
        (function () {
            const mq = window.matchMedia('(max-width: 1023px)');
            const accordionBtns = Array.from(document.querySelectorAll('.footer-accordion-btn'));
            const panels = Array.from(document.querySelectorAll('.footer-accordion-panel'));

            function closeAll() {
                accordionBtns.forEach(btn => {
                    btn.setAttribute('aria-expanded', 'false');
                    btn.querySelector('.icon').textContent = '+';
                });
                panels.forEach(panel => {
                    panel.setAttribute('aria-hidden', 'true');
                });
            }

            function openPanel(idx) {
                accordionBtns[idx].setAttribute('aria-expanded', 'true');
                accordionBtns[idx].querySelector('.icon').textContent = '−';
                panels[idx].setAttribute('aria-hidden', 'false');
            }

            function handleAccordionClick(e) {
                const idx = accordionBtns.indexOf(e.currentTarget);
                const expanded = e.currentTarget.getAttribute('aria-expanded') === 'true';
                closeAll();
                if (!expanded) {
                    openPanel(idx);
                }
            }

            function handleAccordionKeydown(e) {
                const idx = accordionBtns.indexOf(e.currentTarget);
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    accordionBtns[(idx + 1) % accordionBtns.length].focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    accordionBtns[(idx - 1 + accordionBtns.length) % accordionBtns.length].focus();
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    accordionBtns[0].focus();
                } else if (e.key === 'End') {
                    e.preventDefault();
                    accordionBtns[accordionBtns.length - 1].focus();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleAccordionClick.call(e.currentTarget, e);
                }
            }

            function updateAccordionDisplay() {
                if (mq.matches) {
                    // Show accordion, hide headings
                    accordionBtns.forEach(btn => (btn.style.display = 'block'));
                    document.querySelectorAll('.footer-heading').forEach(h => (h.style.display = 'none'));
                } else {
                    // Hide accordion, show headings
                    accordionBtns.forEach(btn => (btn.style.display = 'none'));
                    panels.forEach(panel => {
                        panel.setAttribute('aria-hidden', 'false');
                    });
                    document.querySelectorAll('.footer-heading').forEach(h => (h.style.display = 'block'));
                }
            }

            accordionBtns.forEach((btn, idx) => {
                btn.addEventListener('click', handleAccordionClick);
                btn.addEventListener('keydown', handleAccordionKeydown);
            });

            // On load, open the first section on mobile/tablet
            function initAccordion() {
                closeAll();
                if (!mq.matches) {
                    panels.forEach(panel => panel.setAttribute('aria-hidden', 'false'));
                }
                updateAccordionDisplay();
            }

            mq.addEventListener('change', initAccordion);
            window.addEventListener('DOMContentLoaded', initAccordion);
            window.addEventListener('resize', updateAccordionDisplay);
        })();
    </script>
    <!-- Space Selection Modal Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Constants
            const POPOVER_OFFSET_X = 19;
            const POPOVER_OFFSET_Y = 235;

            // Helper functions
            function capitalizeSpace(space) {
                return space.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Cached DOM Elements - Main
            const selectSpaceBtn = document.getElementById('select-space-btn');
            const modal = document.getElementById('space-selection-modal');
            const closeBtn = document.getElementById('modal-close-btn');
            const backBtn = document.getElementById('modal-back-btn');
            const modalOverlay = document.querySelector('.space-selection-modal-overlay');
            const modalTabs = document.getElementById('modal-tabs');

            // Cached DOM Elements - Scenes
            const buildingOverviewScene = document.getElementById('building-overview-scene');
            const detailScene = document.getElementById('detail-scene');
            const popover = document.getElementById('space-popover');
            const adminOfficeOverlay = document.querySelector('.admin-office-overlay');

            // Cached NodeLists
            const tabs = document.querySelectorAll('.space-selection-modal-tab');
            const shareBtn = document.querySelector('.space-selection-modal-share-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const productCards = document.querySelectorAll('.product-card');
            const dots = document.querySelectorAll('.dot');
            const hvacComponents = document.querySelectorAll('.hvac-component');

            // SVG and overlay elements
            const buildingSvgObject = document.getElementById('building-svg-object');
            const markerOverlayContainer = document.getElementById('marker-overlay-container');
            const spaceSvgObject = document.getElementById('space-svg-object');
            const spaceMarkerOverlayContainer = document.getElementById('space-marker-overlay-container');
            const schoolBuilding = document.querySelector('.school-building');

            // Marker data storage
            let markerData = {};
            let resizeTimeout = null;
            const originalBuildingSvgPath = './Content/imgs/K-12Map-with-Pins.svg';
            const MARKER_DATA_STORAGE_KEY = 'k12-marker-data';
            const MARKER_DATA_VERSION = '1.0';

            // Space to SVG file mapping
            const spaceToSvgMap = {
                'admin-offices': './Content/imgs/K-12 Spaces/K-12-Admin.svg',
                'cafeteria': './Content/imgs/K-12 Spaces/K-12-Cafeteria.svg',
                'classrooms': './Content/imgs/K-12 Spaces/K-12-Classrooms.svg',
                'gym': './Content/imgs/K-12 Spaces/K-12-Gym.svg',
                'kitchen': './Content/imgs/K-12 Spaces/K-12-Kitchen.svg',
                'lobby': './Content/imgs/K-12 Spaces/K-12-Lobby.svg',
                'locker-room': './Content/imgs/K-12 Spaces/K-12-LockerRoom.svg',
                'science-lab': './Content/imgs/K-12 Spaces/K-12-ScienceLab.svg'
            };

            // Text ID to space key mapping
            const textIdToSpaceMap = {
                'Gym': 'gym',
                'Lobby': 'lobby',
                'Admin-Offices': 'admin-offices',
                'Locker-Room': 'locker-room',
                'Science-Lab': 'science-lab',
                'Classrooms': 'classrooms',
                'Kitchen': 'kitchen',
                'Cafeteria': 'cafeteria'
            };

            // System data
            const spaceSystemMap = {
                'classrooms': 'Dedicated Outdoor Air System(DOAS)',
                'science-lab': 'DOAS',
                'locker-room': 'DOAS',
                'admin-offices': 'Multi-zone variable air volume',
                'gym': 'DOAS',
                'lobby': 'DOAS',
                'cafeteria': 'DOAS',
                'kitchen': 'DOAS'
            };

            // Top markers (roof/upper level markers) - popover should appear at top of modal
            const topMarkers = ['gym', 'lobby', 'locker-room', 'science-lab', 'cafeteria', 'kitchen'];

            // Helper function to accumulate all parent transforms
            function getParentTransforms(element) {
                const transforms = [];
                let current = element;

                while (current && current !== current.ownerDocument.documentElement) {
                    const transform = current.getAttribute('transform') || '';
                    const translateMatch = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (translateMatch) {
                        transforms.push({
                            x: parseFloat(translateMatch[1]),
                            y: parseFloat(translateMatch[2])
                        });
                    }
                    current = current.parentElement;
                }

                return transforms;
            }

            // Extract marker positions and titles from SVG
            function extractMarkerPositions(svgDoc) {
                if (!svgDoc) return {};

                const svg = svgDoc.documentElement;
                const viewBox = svg.getAttribute('viewBox') || '0 0 1417 600';
                const viewBoxValues = viewBox.split(' ').map(Number);
                const svgWidth = viewBoxValues[2] || 1417;
                const svgHeight = viewBoxValues[3] || 600;

                const markers = {};

                // Find all marker groups
                const markerGroups = [
                    ...Array.from(svgDoc.querySelectorAll('g[id="Group-18"]')),
                    svgDoc.getElementById('admin-offices-target'),
                    svgDoc.getElementById('Kitchen-marker'),
                    svgDoc.getElementById('cafeteria-marker')
                ].filter(Boolean);

                markerGroups.forEach(markerGroup => {
                    // Find text element within the marker group
                    const textEl = markerGroup.querySelector('text[id]');
                    if (!textEl || !textEl.id) return;

                    const textId = textEl.id;
                    const spaceKey = textIdToSpaceMap[textId];
                    if (!spaceKey) return;

                    // Skip if we already have a marker for this space (deduplicate)
                    if (markers[spaceKey]) return;

                    // Get text content for title
                    const title = textEl.textContent || textId;

                    // Get all parent transforms
                    const parentTransforms = getParentTransforms(markerGroup);

                    // Sum up all transform X and Y values
                    let totalX = 0;
                    let totalY = 0;
                    parentTransforms.forEach(t => {
                        totalX += t.x;
                        totalY += t.y;
                    });

                    // Try to get bounding box for more accurate center position
                    let markerCenterX = totalX;
                    let markerCenterY = totalY;

                    try {
                        // Get bbox in the marker group's local coordinate system
                        const bbox = markerGroup.getBBox();
                        if (bbox.width > 0 && bbox.height > 0) {
                            // The bbox is relative to the marker group's coordinate system
                            // Add the center of the bbox to the accumulated transforms
                            markerCenterX = totalX + bbox.x + (bbox.width / 2);
                            markerCenterY = totalY + bbox.y + (bbox.height / 2);
                        } else {
                            // Fallback: try text element bbox
                            try {
                                const textBbox = textEl.getBBox();
                                if (textBbox.width > 0 && textBbox.height > 0) {
                                    markerCenterX = totalX + textBbox.x + (textBbox.width / 2);
                                    markerCenterY = totalY + textBbox.y + (textBbox.height / 2);
                                }
                            } catch (e) {
                                // Use transform position if bbox fails
                            }
                        }
                    } catch (e) {
                        // Use transform position if getBBox fails
                    }

                    markers[spaceKey] = {
                        x: markerCenterX,
                        y: markerCenterY,
                        title: title,
                        system: spaceSystemMap[spaceKey] || 'DOAS',
                        svgX: markerCenterX / svgWidth,
                        svgY: markerCenterY / svgHeight
                    };

                    // Debug logging
                    console.log(`Marker ${spaceKey}:`, {
                        title: title,
                        absoluteX: markerCenterX,
                        absoluteY: markerCenterY,
                        percentageX: (markerCenterX / svgWidth * 100).toFixed(2) + '%',
                        percentageY: (markerCenterY / svgHeight * 100).toFixed(2) + '%'
                    });
                });

                return markers;
            }

            // Create responsive marker overlay
            function createMarkerOverlay(markerInfo, container) {
                const marker = document.createElement('div');
                marker.className = 'clickable-area';
                marker.setAttribute('data-space', markerInfo.spaceKey);
                marker.setAttribute('data-system', markerInfo.system);
                marker.style.position = 'absolute';
                marker.style.left = `${markerInfo.svgX * 100}%`;
                marker.style.top = `${markerInfo.svgY * 100}%`;
                marker.style.transform = 'translate(-50%, -50%)';
                marker.style.zIndex = '20';
                marker.style.cursor = 'pointer';

                const icon = document.createElement('div');
                icon.className = 'space-icon';

                const label = document.createElement('div');
                label.className = 'space-label';
                label.textContent = markerInfo.title;

                marker.appendChild(icon);
                marker.appendChild(label);

                container.appendChild(marker);

                return marker;
            }

            // Update marker positions on resize
            function updateMarkerPositions() {
                if (!buildingSvgObject || !markerOverlayContainer) return;

                // Update all marker positions (positions are percentage-based so they scale automatically)
                markerOverlayContainer.querySelectorAll('.clickable-area').forEach(marker => {
                    const spaceKey = marker.getAttribute('data-space');
                    const markerInfo = markerData[spaceKey];
                    if (markerInfo) {
                        marker.style.left = `${markerInfo.svgX * 100}%`;
                        marker.style.top = `${markerInfo.svgY * 100}%`;
                    }
                });

                // Update popover position if visible
                if (isPopoverVisible && previousClickedMarker) {
                    // Use stored position if available (to prevent reset during SVG replacement)
                    if (storedPopoverPosition) {
                        popover.style.left = `${storedPopoverPosition.x}px`;
                        popover.style.top = `${storedPopoverPosition.y}px`;
                        // Update pointer position if it was set
                        if (storedPopoverPosition.pointerLeft !== null && storedPopoverPosition.pointerLeft !== undefined) {
                            popover.style.setProperty('--pointer-left', `${storedPopoverPosition.pointerLeft}px`);
                            popover.setAttribute('data-pointer-left', storedPopoverPosition.pointerLeft);
                        } else {
                            popover.removeAttribute('data-pointer-left');
                            popover.style.removeProperty('--pointer-left');
                        }
                    } else {
                        // Fallback: recalculate if stored position is not available
                        const clickableAreaRect = previousClickedMarker.getBoundingClientRect();
                        const position = calculatePopoverPosition(clickableAreaRect, currentSpace || '');
                        storedPopoverPosition = position;
                        showPopover(currentSpace, currentSystem, position.x, position.y, position.pointerLeft);
                    }
                }

                // Update space SVG marker positions if in detail scene
                if (detailScene.classList.contains('active')) {
                    updateSpaceSvgMarkerPositions();
                }
            }

            // Save marker data to localStorage
            function saveMarkerDataToStorage(data) {
                try {
                    const storageData = {
                        version: MARKER_DATA_VERSION,
                        data: data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(MARKER_DATA_STORAGE_KEY, JSON.stringify(storageData));
                } catch (e) {
                    console.warn('Failed to save marker data to localStorage:', e);
                }
            }

            // Load marker data from localStorage
            function loadMarkerDataFromStorage() {
                try {
                    const stored = localStorage.getItem(MARKER_DATA_STORAGE_KEY);
                    if (!stored) return null;

                    const storageData = JSON.parse(stored);

                    // Check version compatibility
                    if (storageData.version !== MARKER_DATA_VERSION) {
                        console.log('Marker data version mismatch, will re-extract');
                        return null;
                    }

                    return storageData.data;
                } catch (e) {
                    console.warn('Failed to load marker data from localStorage:', e);
                    return null;
                }
            }

            // Create marker overlays from stored data
            function createMarkerOverlaysFromData(data) {
                if (!data || Object.keys(data).length === 0) return false;

                markerData = data;

                // Create marker overlays
                markerOverlayContainer.innerHTML = '';
                Object.keys(markerData).forEach(spaceKey => {
                    const markerInfo = {
                        ...markerData[spaceKey],
                        spaceKey: spaceKey
                    };
                    createMarkerOverlay(markerInfo, markerOverlayContainer);
                });

                // Update clickable areas reference
                const newClickableAreas = markerOverlayContainer.querySelectorAll('.clickable-area');
                setupMarkerClickHandlers(newClickableAreas);

                return true;
            }

            // Load building SVG and extract markers
            function initializeBuildingSvg() {
                if (!buildingSvgObject) return;

                // Try to load from localStorage first
                const storedMarkerData = loadMarkerDataFromStorage();
                if (storedMarkerData) {
                    if (createMarkerOverlaysFromData(storedMarkerData)) {
                        console.log('Marker data loaded from localStorage');
                        return;
                    }
                }

                // If not in storage or load failed, extract from SVG
                function extractAndSaveMarkers() {
                    const svgDoc = buildingSvgObject.contentDocument;
                    if (!svgDoc) return;

                    // Extract marker positions
                    markerData = extractMarkerPositions(svgDoc);

                    // Save to localStorage
                    saveMarkerDataToStorage(markerData);

                    // Create marker overlays
                    markerOverlayContainer.innerHTML = '';
                    Object.keys(markerData).forEach(spaceKey => {
                        const markerInfo = {
                            ...markerData[spaceKey],
                            spaceKey: spaceKey
                        };
                        createMarkerOverlay(markerInfo, markerOverlayContainer);
                    });

                    // Update clickable areas reference
                    const newClickableAreas = markerOverlayContainer.querySelectorAll('.clickable-area');
                    setupMarkerClickHandlers(newClickableAreas);
                }

                // Check if SVG is already loaded
                if (buildingSvgObject.contentDocument && buildingSvgObject.contentDocument.readyState === 'complete') {
                    extractAndSaveMarkers();
                } else {
                    buildingSvgObject.addEventListener('load', extractAndSaveMarkers, { once: true });
                }
            }

            // Replace building SVG with space SVG
            function replaceBuildingSvg(spaceKey) {
                const svgPath = spaceToSvgMap[spaceKey];
                if (!svgPath || !buildingSvgObject) return;

                // Replace the building SVG with the space SVG
                buildingSvgObject.setAttribute('data', svgPath);
            }

            // Restore original building SVG
            function restoreBuildingSvg() {
                if (!buildingSvgObject) return;
                buildingSvgObject.setAttribute('data', originalBuildingSvgPath);
            }

            // Setup marker click handlers
            function setupMarkerClickHandlers(clickableAreas) {
                clickableAreas.forEach(area => {
                    area.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const space = this.getAttribute('data-space');
                        const system = this.getAttribute('data-system');

                        // Reset previous marker if exists
                        if (previousClickedMarker && previousClickedMarker !== this) {
                            previousClickedMarker.style.display = 'flex';
                        }

                        // Store the clickable area position before hiding it
                        const clickableAreaRect = this.getBoundingClientRect();

                        // Hide the clicked area
                        this.style.display = 'none';

                        // Track this marker as the previous one
                        previousClickedMarker = this;

                        // Calculate and store popover position BEFORE replacing SVG
                        // This prevents the position from being reset when ResizeObserver fires
                        const position = calculatePopoverPosition(clickableAreaRect, space);
                        storedPopoverPosition = position;

                        // Replace the building SVG with the space SVG
                        replaceBuildingSvg(space);

                        // Show popover with stored position and pointer adjustment
                        showPopover(space, system, position.x, position.y, position.pointerLeft);
                    });
                });
            }

            // Load space SVG with marker overlay
            function loadSpaceSvg(spaceKey) {
                const svgPath = spaceToSvgMap[spaceKey];
                if (!svgPath || !spaceSvgObject) return;

                // Clear previous overlay
                spaceMarkerOverlayContainer.innerHTML = '';

                // Set new SVG source
                spaceSvgObject.setAttribute('data', svgPath);

                // Handle SVG load
                function onSpaceSvgLoad() {
                    const markerInfo = markerData[spaceKey];
                    if (!markerInfo) return;

                    // Create marker overlay
                    const marker = document.createElement('div');
                    marker.className = 'space-marker';
                    marker.style.position = 'absolute';
                    marker.style.left = `${markerInfo.svgX * 100}%`;
                    marker.style.top = `${markerInfo.svgY * 100}%`;
                    marker.style.transform = 'translate(-50%, -50%)';
                    marker.style.zIndex = '20';

                    const icon = document.createElement('div');
                    icon.className = 'space-icon';

                    marker.appendChild(icon);
                    spaceMarkerOverlayContainer.appendChild(marker);

                    // Create title overlay
                    const title = document.createElement('div');
                    title.className = 'space-title-overlay';
                    title.textContent = markerInfo.title;
                    title.style.position = 'absolute';
                    title.style.left = `${markerInfo.svgX * 100}%`;
                    title.style.top = `${markerInfo.svgY * 100}%`;
                    title.style.transform = 'translate(-50%, calc(-50% + 30px))';
                    title.style.zIndex = '20';
                    spaceMarkerOverlayContainer.appendChild(title);
                }

                // Check if SVG is already loaded
                if (spaceSvgObject.contentDocument && spaceSvgObject.contentDocument.readyState === 'complete') {
                    onSpaceSvgLoad();
                } else {
                    spaceSvgObject.addEventListener('load', onSpaceSvgLoad, { once: true });
                }
            }

            // Update space SVG marker positions on resize
            function updateSpaceSvgMarkerPositions() {
                if (!spaceMarkerOverlayContainer) return;

                const marker = spaceMarkerOverlayContainer.querySelector('.space-marker');
                const title = spaceMarkerOverlayContainer.querySelector('.space-title-overlay');

                if (!marker || !title) return;

                const spaceKey = currentSpace;
                const markerInfo = markerData[spaceKey];
                if (!markerInfo) return;

                // Positions are already percentage-based, so they should scale automatically
                // But we can ensure they're set correctly
                marker.style.left = `${markerInfo.svgX * 100}%`;
                marker.style.top = `${markerInfo.svgY * 100}%`;
                title.style.left = `${markerInfo.svgX * 100}%`;
                title.style.top = `${markerInfo.svgY * 100}%`;
            }

            // Resize handler with debouncing
            function handleResize() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateMarkerPositions();
                }, 100);
            }

            // Initialize on load
            initializeBuildingSvg();

            // Setup resize observer
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(handleResize);
                if (schoolBuilding) {
                    resizeObserver.observe(schoolBuilding);
                }
                if (buildingSvgObject) {
                    resizeObserver.observe(buildingSvgObject);
                }
                const spaceSvgContainer = document.querySelector('.space-svg-container');
                if (spaceSvgContainer) {
                    resizeObserver.observe(spaceSvgContainer);
                }
            } else {
                window.addEventListener('resize', handleResize);
            }

            // Popover elements
            const popoverCloseBtn = document.getElementById('popover-close-btn');
            const popoverViewBtn = document.getElementById('popover-view-btn');
            const popoverSpaceName = document.getElementById('popover-space-name');
            const popoverSystemName = document.getElementById('popover-system-name');

            // Detail scene elements
            const modalSpaceName = document.querySelector('.space-selection-modal-space-name');
            const modalSystemName = document.getElementById('modal-system-name');
            const detailTitle = document.getElementById('detail-title');
            const detailDescription = document.getElementById('detail-description');

            // State
            let currentSpace = null;
            let currentSystem = null;
            let currentProductIndex = 0;
            let isPopoverVisible = false;
            let focusableElements = [];
            let firstFocusableElement = null;
            let lastFocusableElement = null;
            let previousClickedMarker = null;
            let storedPopoverPosition = null; // Store popover position to prevent reset on SVG replacement

            // Focus trap helper
            function updateFocusableElements() {
                const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
                focusableElements = Array.from(modal.querySelectorAll(focusableSelectors));
                firstFocusableElement = focusableElements[0];
                lastFocusableElement = focusableElements[focusableElements.length - 1];
            }

            function trapFocus(e) {
                if (e.key !== 'Tab') {
                    return;
                }

                if (e.shiftKey) {
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        e.preventDefault();
                    }
                }
            }

            // Open modal
            selectSpaceBtn.addEventListener('click', function () {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Initialize SVG if not already initialized
                if (Object.keys(markerData).length === 0) {
                    initializeBuildingSvg();
                }

                showBuildingOverview();
                updateFocusableElements();
                setTimeout(() => closeBtn.focus(), 100);
                modal.addEventListener('keydown', trapFocus);
            });

            // Close modal
            function closeModal() {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                hidePopover();
                showBuildingOverview();
                modal.removeEventListener('keydown', trapFocus);
                selectSpaceBtn.focus();
            }

            closeBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', function (e) {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });

            // Show building overview scene
            function showBuildingOverview() {
                buildingOverviewScene.classList.add('active');
                detailScene.classList.remove('active');
                backBtn.style.display = 'none';
                modalSpaceName.textContent = '';
                modalSystemName.style.display = 'none';
                modalTabs.style.display = 'flex';

                // Disable tab buttons and share button in overview scene
                tabs.forEach(tab => {
                    tab.disabled = true;
                });
                if (shareBtn) {
                    shareBtn.disabled = true;
                }

                // Show all clickable areas again
                if (markerOverlayContainer) {
                    markerOverlayContainer.querySelectorAll('.clickable-area').forEach(area => {
                        area.style.display = 'flex';
                    });
                }

                // Reset marker tracking
                previousClickedMarker = null;
                storedPopoverPosition = null; // Clear stored position

                // Restore original building SVG
                restoreBuildingSvg();

                updateFocusableElements();
            }

            // Show detail scene
            function showDetailScene(space, system) {
                currentSpace = space;
                currentSystem = system;

                buildingOverviewScene.classList.remove('active');
                detailScene.classList.add('active');
                backBtn.style.display = 'flex';
                modalSpaceName.textContent = capitalizeSpace(space);
                modalSystemName.textContent = system;
                modalSystemName.style.display = 'block';
                modalTabs.style.display = 'flex';

                // Ensure Overview tab is selected and its content is shown
                tabs.forEach(tab => {
                    tab.disabled = false;
                    tab.classList.remove('active');
                });
                if (shareBtn) {
                    shareBtn.disabled = false;
                }
                const overviewTab = document.querySelector('[data-tab="overview"]');
                if (overviewTab) {
                    overviewTab.classList.add('active');
                }

                // Show Overview content
                tabContents.forEach(content => content.classList.remove('active'));
                const overviewContent = document.getElementById('overview-content');
                if (overviewContent) {
                    overviewContent.classList.add('active');
                }

                // Update content based on space
                updateDetailContent(space, system);

                // Load space SVG with marker overlay
                loadSpaceSvg(space);

                updateFocusableElements();
            }

            // Update detail content based on space
            function updateDetailContent(space, system) {
                const spaceData = {
                    'classrooms': {
                        title: 'Classroom Overview',
                        description: 'The flexible design decouples ventilation air and loads, allowing the DOAS units to handle latent loads and condition air while secondary HVAC systems handle sensible loads. This approach provides better control, energy efficiency, and comfort. Proper control is essential for maintaining comfort and extending equipment lifespan.',
                        equipment: [
                            'Dedicated Outdoor Air System (DOAS) with energy recovery',
                            'Secondary HVAC system (not provided by Greenheck)'
                        ]
                    },
                    'gym': {
                        title: 'Gym Overview',
                        description: 'The gymnasium features a single-zone, variable airflow system designed for high occupancy and activity levels. The system includes demand-controlled ventilation and high-volume, low-speed fans for optimal air circulation.',
                        equipment: [
                            'High Volume Low Speed (HVLS) fans',
                            'Demand-controlled ventilation system'
                        ]
                    }
                };

                const data = spaceData[space] || spaceData['classrooms'];
                detailTitle.textContent = data.title;
                detailDescription.textContent = data.description;
            }

            // Calculate popover position based on clickable area position and popover dimensions
            function calculatePopoverPosition(clickableAreaRect, spaceName = '') {
                if (!popover) return { x: 0, y: 0, pointerLeft: null };

                // Get modal container for bounds checking
                const modal = document.getElementById('space-selection-modal');
                const modalContainer = document.querySelector('.space-selection-modal-container');
                const modalContent = document.querySelector('.space-selection-modal-content');
                if (!modal || !modalContainer || !modalContent) return { x: 0, y: 0, pointerLeft: null };

                const modalRect = modal.getBoundingClientRect();
                const modalContainerRect = modalContainer.getBoundingClientRect();
                const modalContentRect = modalContent.getBoundingClientRect();
                const containerWidth = modalContentRect.width;
                const containerHeight = modalContentRect.height;
                const padding = 10; // Padding from edges
                const pointerHeight = 8; // Height of the pointer triangle (from CSS border-top: 8px)

                // Get popover dimensions (we need to show it first to measure)
                const wasVisible = popover.style.display !== 'none';
                const originalVisibility = popover.style.visibility;
                if (!wasVisible) {
                    popover.style.display = 'flex';
                    popover.style.visibility = 'hidden';
                }

                const popoverRect = popover.getBoundingClientRect();
                const popoverWidth = popoverRect.width || 300; // Fallback width if measurement fails
                const popoverHeight = popoverRect.height || 200; // Fallback height if measurement fails

                if (!wasVisible) {
                    popover.style.display = 'none';
                    popover.style.visibility = originalVisibility;
                }

                // Get clickable area center position (relative to viewport for fixed positioning)
                const clickableAreaCenterX = clickableAreaRect.left + clickableAreaRect.width / 2;
                const clickableAreaCenterY = clickableAreaRect.top + clickableAreaRect.height / 2;

                // Check if this is a top marker (case-insensitive check)
                const isTopMarker = spaceName && topMarkers.includes(spaceName.toLowerCase());

                // Calculate X position: center of clickable area (viewport coordinates for fixed positioning)
                // Account for transform: translateX(-50%) which centers the popover horizontally
                let x = clickableAreaCenterX;
                const halfPopoverWidth = popoverWidth / 2;
                let pointerLeft = null; // For top markers, we'll adjust pointer position

                // Adjust X position to stay within modal bounds (accounting for transform)
                const modalLeft = modalContentRect.left;
                const modalRight = modalContentRect.right;
                if (x - halfPopoverWidth < modalLeft + padding) {
                    x = modalLeft + padding + halfPopoverWidth;
                } else if (x + halfPopoverWidth > modalRight - padding) {
                    x = Math.max(modalLeft + padding + halfPopoverWidth, modalRight - halfPopoverWidth - padding);
                }

                // For top markers, position popover at the top of the modal content area (below header)
                let y;
                if (isTopMarker) {
                    // Position at top of modal content area with padding (viewport coordinates)
                    // This places it at the top of the content area, just below the header
                    y = modalContentRect.top + padding;

                    // Calculate pointer position AFTER x has been adjusted for boundaries
                    // The pointer needs to point from the popover (at top) down to the marker
                    // markerXRelative is the marker center X relative to viewport
                    const markerXRelative = clickableAreaCenterX;
                    // popoverLeft is the popover's left edge relative to viewport (after boundary adjustments)
                    const popoverLeft = x - halfPopoverWidth;
                    // pointerLeft is the distance from popover's left edge to where pointer center should be
                    // Since CSS uses translateX(-50%), the left value represents the center of the pointer
                    pointerLeft = markerXRelative - popoverLeft;

                    // Clamp pointer position to stay within popover bounds (with some margin)
                    // The pointer is 16px wide (8px border on each side), so we need at least 8px margin
                    const pointerMargin = 20; // Keep pointer away from edges
                    pointerLeft = Math.max(pointerMargin, Math.min(pointerLeft, popoverWidth - pointerMargin));

                    console.log('Top marker pointer calculation:', {
                        markerX: Math.round(markerXRelative),
                        popoverX: Math.round(x),
                        popoverLeft: Math.round(popoverLeft),
                        popoverWidth: Math.round(popoverWidth),
                        calculatedPointerLeft: Math.round(pointerLeft),
                        clampedPointerLeft: Math.round(pointerLeft)
                    });
                } else {
                    // For non-top markers, position above the marker
                    // Calculate Y position: popover top = clickable area center Y - popover height - pointer height
                    // This positions the popover so its bottom center pointer aligns with the clickable area center
                    y = clickableAreaCenterY - popoverHeight - pointerHeight;

                    // Adjust Y position to stay within modal bounds
                    const modalTop = modalContentRect.top;
                    const modalBottom = modalContentRect.bottom;
                    if (y < modalTop + padding) {
                        // If popover would go above modal, position it below clickable area instead
                        y = clickableAreaCenterY + pointerHeight;
                        // Check if it fits below
                        if (y + popoverHeight > modalBottom - padding) {
                            y = Math.max(modalTop + padding, modalBottom - popoverHeight - padding);
                        }
                    } else if (y + popoverHeight + pointerHeight > modalBottom - padding) {
                        y = Math.max(modalTop + padding, modalBottom - popoverHeight - pointerHeight - padding);
                    }
                }

                // Handle edge case: if popover is larger than container, center it
                if (popoverWidth > containerWidth - (padding * 2)) {
                    x = modalContainerRect.left + (modalContainerRect.width / 2); // Center horizontally within modal container
                    console.warn(`Popover width (${popoverWidth}px) exceeds available container width, centering horizontally`);
                }
                if (popoverHeight + pointerHeight > containerHeight - (padding * 2)) {
                    y = modalContainerRect.top + padding;
                    console.warn(`Popover height (${popoverHeight}px) exceeds available container height, centering vertically`);
                }

                // Log position calculations for debugging
                console.log(`Popover position calculated${spaceName ? ` for ${spaceName}` : ''}:`, {
                    isTopMarker: isTopMarker,
                    spaceName: spaceName,
                    topMarkersList: topMarkers,
                    clickableAreaCenter: {
                        x: Math.round(clickableAreaCenterX - modalContentRect.left),
                        y: Math.round(clickableAreaCenterY - modalContentRect.top)
                    },
                    popoverSize: { width: Math.round(popoverWidth), height: Math.round(popoverHeight) },
                    pointerHeight: pointerHeight,
                    pointerLeft: pointerLeft !== null ? Math.round(pointerLeft) : 'center',
                    finalPosition: { x: Math.round(x), y: Math.round(y) },
                    containerSize: { width: Math.round(containerWidth), height: Math.round(containerHeight) }
                });

                return { x, y, pointerLeft };
            }

            // Show popover
            function showPopover(space, system, x, y, pointerLeft = null) {
                currentSpace = space;
                currentSystem = system;
                isPopoverVisible = true;

                // Move popover to body if not already there (for fixed positioning)
                if (popover.parentElement !== document.body) {
                    document.body.appendChild(popover);
                }

                popoverSpaceName.textContent = capitalizeSpace(space);
                popoverSystemName.textContent = system;
                popover.style.display = 'flex';
                popover.style.left = `${x}px`;
                popover.style.top = `${y}px`;

                // Adjust pointer position for top markers
                if (pointerLeft !== null && pointerLeft !== undefined) {
                    // Set pointer position using CSS custom property
                    // pointerLeft is the distance from popover's left edge to marker center
                    popover.style.setProperty('--pointer-left', `${pointerLeft}px`);
                    popover.setAttribute('data-pointer-left', pointerLeft);
                    console.log('Setting pointer position:', {
                        pointerLeft: pointerLeft,
                        cssVar: `--pointer-left: ${pointerLeft}px`,
                        dataAttr: `data-pointer-left="${pointerLeft}"`
                    });
                } else {
                    popover.removeAttribute('data-pointer-left');
                    popover.style.removeProperty('--pointer-left');
                }
            }

            // Hide popover
            function hidePopover() {
                popover.style.display = 'none';
                isPopoverVisible = false;
                storedPopoverPosition = null; // Clear stored position
                // Restore original building SVG when popover is closed
                restoreBuildingSvg();
            }

            // Clickable areas functionality is now handled in setupMarkerClickHandlers

            // Popover view button
            popoverViewBtn.addEventListener('click', function () {
                // Enable tab buttons and share button, and select Overview
                tabs.forEach(tab => {
                    tab.disabled = false;
                    tab.classList.remove('active');
                });
                if (shareBtn) {
                    shareBtn.disabled = false;
                }
                // Select Overview tab
                const overviewTab = document.querySelector('[data-tab="overview"]');
                if (overviewTab) {
                    overviewTab.classList.add('active');
                }

                hidePopover();
                showDetailScene(currentSpace, currentSystem);
            });

            // Popover close button
            popoverCloseBtn.addEventListener('click', function () {
                hidePopover();
                // Show all clickable areas when popover is closed
                if (markerOverlayContainer) {
                    markerOverlayContainer.querySelectorAll('.clickable-area').forEach(area => {
                        area.style.display = 'flex';
                    });
                }
                // Reset marker tracking
                previousClickedMarker = null;
            });

            // Back button
            backBtn.addEventListener('click', function () {
                showBuildingOverview();
            });

            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.dataset.tab;

                    // Update tab states
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Update tab content
                    tabContents.forEach(content => content.classList.remove('active'));
                    const targetContent = document.getElementById(`${tabName}-content`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            // Product carousel functionality
            function showProduct(index) {
                productCards.forEach((card, i) => {
                    card.classList.toggle('active', i === index);
                });
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            }

            // Event delegation for carousel controls
            document.addEventListener('click', function (e) {
                const prevBtn = e.target.closest('.carousel-prev');
                const nextBtn = e.target.closest('.carousel-next');

                if (prevBtn && modal.style.display === 'flex') {
                    currentProductIndex = currentProductIndex > 0 ? currentProductIndex - 1 : productCards.length - 1;
                    showProduct(currentProductIndex);
                } else if (nextBtn && modal.style.display === 'flex') {
                    currentProductIndex = currentProductIndex < productCards.length - 1 ? currentProductIndex + 1 : 0;
                    showProduct(currentProductIndex);
                }
            });

            // HVAC component clicks
            hvacComponents.forEach(component => {
                component.addEventListener('click', function () {
                    const product = this.dataset.product;
                    if (product) {
                        // Find and show the corresponding product card
                        const productCard = document.querySelector(`[data-product="${product}"]`);
                        if (productCard) {
                            const cardIndex = Array.from(productCards).indexOf(productCard);
                            if (cardIndex !== -1) {
                                currentProductIndex = cardIndex;
                                showProduct(currentProductIndex);
                                // Switch to System Equipment tab
                                tabs.forEach(t => t.classList.remove('active'));
                                const systemEquipmentTab = document.querySelector('[data-tab="system-equipment"]');
                                const systemEquipmentContent = document.getElementById('system-equipment-content');

                                if (systemEquipmentTab) {
                                    systemEquipmentTab.classList.add('active');
                                }

                                tabContents.forEach(content => content.classList.remove('active'));
                                if (systemEquipmentContent) {
                                    systemEquipmentContent.classList.add('active');
                                }
                            }
                        }
                    }
                });
            });

            // Keyboard navigation
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (isPopoverVisible) {
                        hidePopover();
                        // Show all clickable areas when popover is closed
                        if (markerOverlayContainer) {
                            markerOverlayContainer.querySelectorAll('.clickable-area').forEach(area => {
                                area.style.display = 'flex';
                            });
                        }
                        // Reset marker tracking
                        previousClickedMarker = null;
                    } else if (modal.style.display === 'flex') {
                        closeModal();
                    }
                }
            });

            // Click outside popover to close - Only run when popover is visible
            document.addEventListener('click', function (e) {
                if (isPopoverVisible && !popover.contains(e.target) && !e.target.closest('.clickable-area')) {
                    hidePopover();
                    // Show all clickable areas when popover is closed by clicking outside
                    if (markerOverlayContainer) {
                        markerOverlayContainer.querySelectorAll('.clickable-area').forEach(area => {
                            area.style.display = 'flex';
                        });
                    }
                    // Reset marker tracking
                    previousClickedMarker = null;
                }
            });
        });
    </script>
</body>

</html>